variables:
  ADMIN_SOLUTION: "AdminPortal/MOE_System.sln"
  ESERVICE_SOLUTION: "EServicePortal/MOE_System.EService.sln"
  AZURE_APP_NAME: "moe-admin"
  AZURE_APP_NAME_E_SERVICE: "moe-e-service"
  RESOURCE_GROUP: "moe-system-test"
  GITHUB_REPO_BE_HTTPS: "github.com/tdtai09423/moe-be.git"

stages:
  - build
  - test
  - secret-detection
  - sync_to_github
  - deploy

include:
  - template: Security/Secret-Detection.gitlab-ci.yml

default:
  tags:
    - moe-kain

# ==================== BUILD & TEST STAGES ====================

secret_detection:
  stage: secret-detection
  script:
    - Write-Host "Skipping Linux-based Secret Detection on Windows Runner..."
  artifacts:
    reports:
      secret_detection: []
  allow_failure: true

dummy_test:
  stage: test
  script:
    - Write-Host "No unit tests defined yet. Skipping logic check..."
    - Write-Host "Dotnet version check:"
    - dotnet --version

build_admin:
  stage: build
  script:
    - Write-Host "Restoring and Publishing Admin Portal..."
    - dotnet restore $env:ADMIN_SOLUTION
    - dotnet publish AdminPortal/src/MOE_System.API/MOE_System.API.csproj -c Release -o admin_publish
  artifacts:
    name: "admin-package"
    paths:
      - admin_publish/
    expire_in: 1 hour

build_eservice:
  stage: build
  script:
    - Write-Host "Restoring and Publishing EService Portal..."
    - dotnet restore $env:ESERVICE_SOLUTION
    - dotnet publish EServicePortal/src/MOE_System.EService.API/MOE_System.EService.API.csproj -c Release -o eservice_publish
  artifacts:
    name: "e-service-package"
    paths:
      - eservice_publish/
    expire_in: 1 hour

# ==================== SYNC TO GITHUB ====================

sync_to_github:
  stage: sync_to_github
  dependencies:
    - build_admin
    - build_eservice
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: "0" # Crucial to avoid 'index-pack failed'
  script:
    - |
      $ErrorActionPreference = "Stop"
      
      Write-Host "--- 1. Resetting Environment ---"
      git config --global credential.helper ""
      git config --global core.ignorecase true
      git config user.email "gitlab-runner@moe.com"
      git config user.name "GitLab Runner Sync"

      Write-Host "--- 2. Preparing Branch ---"
      git checkout -B main

      Write-Host "--- 3. Pushing to GitHub (Direct URL) ---"
      $githubUrl = "https://x-access-token:${env:GITHUB_TOKEN}@${env:GITHUB_REPO_BE_HTTPS}"
      
      git push $githubUrl main:main --force --atomic
      
      if ($LASTEXITCODE -ne 0) {
          Write-Error "Git push failed! Check if GITHUB_TOKEN has 'workflow' scope."
          exit 1
      }
      
      Write-Host "Successfully synced Backend code to GitHub!"
  when: manual
  only:
    - main
