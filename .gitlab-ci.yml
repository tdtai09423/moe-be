# Use .NET 8.0 SDK
image: mcr.microsoft.com/dotnet/sdk:8.0

# Define Pipeline stages
stages:
  - build
  - test
  - secret-detection
  - deploy

# Include GitLab Security Templates
include:
  - template: Security/Secret-Detection.gitlab-ci.yml

# Environment variables
variables:
  ADMIN_SOLUTION: "AdminPortal/MOE_System.sln"
  ESERVICE_SOLUTION: "EServicePortal/MOE_System.EService.sln"

# ==================== ADMIN PORTAL ====================

# Build Admin Portal
build_admin:
  stage: build
  script:
    - echo "Restoring NuGet packages for Admin Portal..."
    - dotnet restore $ADMIN_SOLUTION
    - echo "Building Admin Portal..."
    - dotnet build $ADMIN_SOLUTION --configuration Release --no-restore
  artifacts:
    paths:
      - AdminPortal/src/MOE_System.API/bin/
      - AdminPortal/src/MOE_System.API/obj/
    expire_in: 1 hour

# Unit Test Admin Portal
# test_admin:
#   stage: test
#   dependencies:
#     - build_admin
#   script:
#     - echo "Running Unit Tests for Admin Portal..."
#     - dotnet test AdminPortal/MOE_System.Admin.UnitTest/MOE_System.Admin.UnitTest.csproj --no-restore --verbosity normal
#     - dotnet test AdminPortal/tests/MOE_System.Application.Tests.csproj --no-restore --verbosity normal
#   allow_failure: false

# Publish Admin Portal
publish_admin:
  stage: deploy
  dependencies:
    - build_admin
  only:
    - main
  script:
    - echo "Publishing Admin Portal..."
    - dotnet publish AdminPortal/src/MOE_System.API/MOE_System.API.csproj -c Release -o ./publish/admin
  artifacts:
    paths:
      - ./publish/admin
    expire_in: 1 week

# ==================== ESERVICE PORTAL ====================

# Build EService Portal
build_eservice:
  stage: build
  script:
    - echo "Restoring NuGet packages for EService Portal..."
    - dotnet restore $ESERVICE_SOLUTION
    - echo "Building EService Portal..."
    - dotnet build $ESERVICE_SOLUTION --configuration Release --no-restore
  artifacts:
    paths:
      - EServicePortal/src/MOE_System.EService.API/bin/
      - EServicePortal/src/MOE_System.EService.API/obj/
    expire_in: 1 hour

# Unit Test EService Portal
# test_eservice:
#   stage: test
#   dependencies:
#     - build_eservice
#   script:
#     - echo "Running Unit Tests for EService Portal..."
#     - dotnet test EServicePortal/MOE_System.EService.UnitTest/MOE_System.EService.UnitTest.csproj --no-restore --verbosity normal
#     - dotnet test EServicePortal/tests/MOE_System.EService.Application.Tests.csproj --no-restore --verbosity normal
#   allow_failure: false

# Publish EService Portal
publish_eservice:
  stage: deploy
  dependencies:
    - build_eservice
  only:
    - main
  script:
    - echo "Publishing EService Portal..."
    - dotnet publish EServicePortal/src/MOE_System.EService.API/MOE_System.EService.API.csproj -c Release -o ./publish/eservice
  artifacts:
    paths:
      - ./publish/eservice
    expire_in: 1 week

# ==================== DEPLOY (Optional) ====================

# Deploy to Development Environment (uncomment if needed)
# deploy_dev:
#   stage: deploy
#   dependencies:
#     - publish_admin
#     - publish_eservice
#   only:
#     - develop
#   script:
#     - echo "Deploying to Development environment..."
#     # Add your deployment commands here (e.g.: scp, rsync, docker, kubernetes, etc.)

# Deploy to Production Environment
# deploy_production:
#   stage: deploy
#   dependencies:
#     - publish_admin
#     - publish_eservice
#   only:
#     - main
#   when: manual  # Require manual confirmation before deploying to production
#   script:
#     - echo "Deploying to Production environment..."
#     # Add your deployment commands here
